https://github.com/putto4u/03.Ansible.IaC.InfraAuto/blob/main/0071.%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%AC%EC%8B%B1%20%EC%8B%A4%EC%8A%B5/0101.%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1%20%EC%9D%B4%ED%95%B4.md

이 장에서는 Nginx를 활용하여 들어오는 모든 요청을 분석하고, 그 성격에 따라 적절한 백엔드 서버로 분산시키는 **L7 로드밸런싱(Application Load Balancing)**의 전반적인 메커니즘을 학습합니다.

---

## 1. 로드밸런서의 기본 작동 원리

로드밸런서는 클라이언트와 백엔드 서버 사이에서 '교통경찰' 역할을 수행합니다. 사용자가 도메인에 접속하면 로드밸런서가 이 요청을 가로채어, 미리 정의된 규칙(Rule)에 따라 최적의 서버로 전달합니다.

* **부하 분산:** 특정 서버에 요청이 몰리지 않도록 나누어 줌.
* **가용성 보장:** 특정 서버가 다운되면 정상적인 서버로만 요청을 전달.
* **보안:** 실제 백엔드 서버의 IP를 외부에 노출하지 않음.

## 2. 경로별 전용 서버 분기 (Content-Based Routing)

단순히 순서대로 나누는 것을 넘어, URL의 **경로(Path)**를 분석하여 특정 목적에 최적화된 서버 그룹으로 요청을 보낼 수 있습니다.

### 구성 시나리오

1. **정적 리소스 (`/css`, `/js`, `/images`):** 성능이 좋은 스토리지나 캐시 서버로 전달. 컨텐츠 별로 나눠주고
2. **API 서버 (`/api`):** 비즈니스 로직을 처리하는 WAS(Web Application Server)로 전달.
3. **관리자 기능 (`/admin`):** 특정 IP에서만 접근 가능한 전용 서버로 전달.
4. **기본 경로 (`/`):** 일반적인 메인 페이지 및 기타 요청 처리. 1-2-3이 없으면 다 4에 해당, 1에서 포함되지 않은 것은 다 4 = 서버에 지정 안했으면 다 4로 가는 것

### Nginx 설정 예시 (정적 설정 방식)

```nginx
# 1. 백엔드 서버 그룹 정의
upstream api_servers {
    server 10.0.1.10:8080; #api로 오면 둘 중 하나로 가라 다
    server 10.0.1.11:8080;
}

upstream static_servers { #밑에 servers에서 지정함 - Static
    server 10.0.1.20:80;
}

upstream main_servers {
    server 10.0.1.30:80;
    server 10.0.1.31:80;
}

# 2. 로드밸런싱 규칙(Location) 설정
server {
    listen 80;
    server_name my-service.com;

    # API 요청: DB 연동, 회원가입, 상품 등록 등
    location /api/ {
        proxy_pass http://api_servers;
    }

    # 정적 리소스: 디자인 파일 등
    location /css/ {
        proxy_pass http://static_servers;
    }

    # 나머지 모든 요청 (기본 로드밸런싱)
    location / {
        proxy_pass http://main_servers;
    }
}

```

## 3. 기능별 액션 및 데이터 흐름 상세 <= 개발팀에서 이렇게 분배해주세요 하고 요청을 하는 것 우린 보통 서버구축하고 이건 알아서 해 이 서버가 nginx니까 conf는 너네가 해 

사용자의 액션에 따라 데이터가 흐르는 경로는 다음과 같이 최적화됩니다.

| 액션 구분 | 경로 (URI) | 대상 서버 그룹 | 처리 내용 |
| --- | --- | --- | --- |
| **사이트 접속** | `/` | `main_servers` | 메인 페이지 HTML 및 기본 화면 구성 요소 응답 |
| **디자인 로드** | `/css/..` | `static_servers` | 스타일시트, 폰트 등 정적 파일 고속 전송 |
| **회원 가입** | `/api/join` | `api_servers` | 사용자 입력 데이터 검증 및 DB Write 요청 |
| **상품 등록** | `/api/product` | `api_servers` | 관리자 권한 확인 후 상품 정보 DB 저장 |
| **데이터 조회** | `/api/list` | `api_servers` | DB Read 작업을 통해 목록 반환 |

#### 3-2. API란
초기api는 함수처럼 코드의 일부를 빌려줬음  
프로그램이 서로 따로 떨어져있을 때 이 기능을 줘봐 했을 때 너 프로그래밍 이름만 대면 그 프로그램에서 요구하는 인자,함수값만 넣어주면 너가 실행해~하는 것  
별개의 프로그램 끼리 기능을 주고 받을 때
-> 이 역할을 하는 게 왓스 서버가 어떤 api인지를 알고 로그인이면 로그인 api를 부르고, 아이디랑 비번을 뿌려줌
=> api가 왓스 서버라고 표현을 하는 곳도 있고 아니라고 하는 곳도 있음 특히 왓스 서버에서 많이 씀    
=> 쿠보네티스, 왓스서버는 api 서버가 다 접수를 받음    
: 여기서는 api가 왓스서버임 (API가 더 큰 개념임)


## 4. 로드밸런싱 알고리즘의 선택

서버 그룹 내에서 요청을 분배할 때 사용하는 대표적인 알고리즘입니다.

* **Round Robin (기본):** 서버 순서대로 하나씩 요청을 할당합니다.
* **Least Connections:** 현재 연결된 접속자 수가 가장 적은 서버로 보냅니다. (유료 서비스나 복잡한 로직 처리에 유리)
* **IP Hash:** 클라이언트의 IP 주소를 기반으로 특정 서버에만 연결합니다. (세션 유지가 필요한 경우 사용) # 중국애들은 따로 받으라고 할 때 (트래픽이 너무 많음) 공격 들어왔을 때 이런식으로 함 성능이 좋은 곳으로 IP를 고정시켜 버림

---

Next Step: 스티키 세션(Sticky Session) 설정, 헬스 체크(Health Check) 상세 설정, HTTPS 적용을 위한 SSL 설정

---
도메인 주소(Host)란 사용자가 브라우저 주소창에 입력하는 웹사이트의 이름(`megashop.com`)을 의미합니다. 리버스 프록시 환경에서는 이 '이름'을 백엔드 서버에 전달해 주는 것이 매우 중요합니다.

가상의 쇼핑몰 환경을 가정하여 각 변수가 실제 어떤 값으로 치환되어 동작하는지 정리합니다.

---

### 1. 가상 환경 설정

| 구분 | 대상 | 상세 정보 |
| --- | --- | --- |
| **서비스 도메인** | 접속 주소 | `www.megashop.com` |
| **클라이언트** | 사용자 PC | IP: `211.10.20.30` |
| **로드밸런서** | Nginx 서버 | IP: `10.0.1.5` (호스트명: `lb-node`) |
| **백엔드 서버 1** | API 서버 A | IP: `10.0.1.11` (호스트명: `api-01`) |
| **백엔드 서버 2** | API 서버 B | IP: `10.0.1.12` (호스트명: `api-02`) |

---

### 2. Nginx 설정 파일 (`nginx.conf.j2`) 적용 예시

앤서블로 배포될 템플릿 파일 내의 각 지시어에 가상의 데이터를 대입하여 설명합니다.

```nginx
location /api/ {
    # 1. 분산 대상 그룹 지정
    proxy_pass http://api_servers;

    # 2. $host 변수 (값: "www.megashop.com")
    # 백엔드 api-01 서버가 "나에게 온 요청이 megashop용이 맞구나"라고 판단하게 함
    proxy_set_header Host $host;

    # 3. $remote_addr 변수 (값: "211.10.20.30")
    # 백엔드 서버 로그에 Nginx IP(10.0.1.5)가 아닌 실제 사용자 IP가 찍히게 함
    proxy_set_header X-Real-IP $remote_addr;

    # 4. $proxy_add_x_forwarded_for 변수 (값: "211.10.20.30")
    # 만약 앞에 다른 보안 장비가 더 있었다면 "IP1, IP2, 211.10.20.30"처럼 누적됨 ==> **틀렸습니다. 반대로가 맞습니다.**   
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # 5. $upstream_addr 변수 (값: "10.0.1.11:8080")
    # 응답 헤더에 "이 요청은 api-01번 서버가 처리했음"을 명시
    add_header X-Backend-Server $upstream_addr;
}

```

---

### 3. 각 변수값의 실제 변화 과정 (Trace)

사용자가 쇼핑몰에서 상품을 조회했을 때의 데이터 변화입니다.

1. **클라이언트 요청:**
* 사용자(`211.10.20.30`)가 `www.megashop.com/api/product`를 호출합니다.


2. **Nginx 수신:**
* Nginx는 `$host`를 `www.megashop.com`으로, `$remote_addr`를 `211.10.20.30`으로 인식합니다.


3. **백엔드 전달 (Header 변조):**
* Nginx가 백엔드 서버 `10.0.1.11`로 요청을 보낼 때, 위 설정에 따라 HTTP 헤더를 다시 작성합니다.
* **Host:** `www.megashop.com` (원래 주소 유지)
* **X-Real-IP:** `211.10.20.30` (사용자 IP 삽입)


4. **백엔드 서버 처리:**
* 백엔드 서버는 `X-Real-IP` 헤더를 보고 "아, `211.10.20.30` 사용자가 우리 쇼핑몰 상품을 보는구나!"라고 인지하여 로그를 남깁니다.


5. **응답 헤더 추가:**
* 사용자의 브라우저 개발자 도구에는 `X-Backend-Server: 10.0.1.11:8080`이라는 헤더가 보이게 됩니다.



---

### 4. 앤서블 인벤토리 및 야믈 파일 구조 (`hosts.ini`)

백엔드 서버 리스트를 동적으로 관리하기 위한 설정입니다.

```ini
[web_servers]
api-01 ansible_host=10.0.1.11
api-02 ansible_host=10.0.1.12

```

---

Next Step: Nginx 가상 호스트(Server Block) 설정, HTTP 헤더 구조 분석, 리버스 프록시 로그 포맷 커스텀

도메인 주소(`Host`)를 전달하는 이유는 백엔드 서버가 여러 개의 사이트를 동시에 운영할 때 어떤 사이트의 요청인지 구분하기 위함이며, IP 관련 변수들은 보안 및 통계 목적의 실제 사용자 추적을 위해 필수적입니다.

---

**작성 가이드 준수 확인**

* AWS 유료 서비스 해당 없음
* 교재 형식 유지 및 깃허브 마크다운 적용
* Next Step: 단답형 핵심 단어 위주
* 불필요한 서술어 제거 (강사님, 설명해 드리겠습니다 등) 완료
* 가상의 쇼핑몰(megashop.com) 예시 적용 완료
