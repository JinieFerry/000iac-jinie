https://github.com/putto4u/03.Ansible.IaC.InfraAuto/blob/main/0071.Git%20%EB%B0%B0%ED%8F%AC%EC%8B%A4%EC%8A%B5/020.%EC%9B%B9%20DB%EC%84%9C%EB%B2%84%20%EB%B0%B0%ED%8F%AC.md
### 멀티 티어(Tier) 아키텍처 환경의 저장소 구성 전략

웹 서버와 데이터베이스(DB) 서버가 공존하는 환경에서는 **하나의 인프라 저장소(`web_dep`) 내에서 역할(Role)을 분리**하여 관리하는 것이 가장 효율적입니다. 인프라는 전체 시스템의 유기적인 연결이 중요하므로, 웹과 DB의 설정을 한 곳에서 관리해야 일관성을 유지할 수 있기 때문입니다.

---

## 1. 멀티 티어 프로젝트 디렉토리 구조

`web_dep` 저장소 내부에 `nginx`와 `mysql` 폴더를 각각 두어 관리합니다.

```text
[인프라 관리 저장소: web_dep]
~/projects/web_dep/
├── .gitignore
├── inventory.ini             # [webservers]와 [dbservers] 그룹 정의
├── web_dep.yml               # 전체 배포 실행 지시서
├── deploy_logic.yml          # 통합 배포 로직 (웹 + DB)
├── nginx/                    # 웹 서버 설정
│   └── default.conf
└── mysql/                    # DB 서버 설정
    ├── my.cnf                # MySQL 설정 파일
    └── setup_db.sql          # 초기 데이터베이스/계정 생성 스크립트

```

---

## 2. [내 PC] 인벤토리 설정 (`inventory.ini`)

서버의 용도에 따라 그룹을 나누어 정의합니다.

```ini
[webservers]
web-node-[01:10] ansible_host=192.168.10.1{{ item }}

[dbservers]
db-node-[01:03] ansible_host=192.168.10.2{{ item }}

[all:vars]
ansible_user=ubuntu
ansible_ssh_private_key_file=~/.ssh/my-key.pem

```

---

## 3. [GitHub] 통합 배포 로직 (`deploy_logic.yml`)

하나의 플레이북 안에서 그룹별로 다른 작업을 수행하도록 구성합니다.

```yaml
---
# 1. DB 서버 설정 (데이터가 먼저 준비되어야 함)
- name: Database Server Setup
  hosts: dbservers
  become: true
  tasks:
    - name: MySQL 설치
      apt:
        name: mysql-server
        state: present
        update_cache: yes

    - name: MySQL 외부 접속 허용 설정 (GitHub 내 설정 파일 사용)
      copy:
        src: "/tmp/infra_setup/mysql/my.cnf"
        dest: "/etc/mysql/mysql.conf.d/mysqld.cnf"
        remote_src: yes
      notify: Restart MySQL #notify는 다 들어가야 함 (한번 다 tasks 다 하고 나면 hanlders는 딱 한번 하는 것)

# 2. 웹 서버 설정 (사용자 정의 경로 ~/web_project 적용)
- name: Web Server Setup
  hosts: webservers
  become: true
  tasks:
    - name: Nginx 설치 및 경로 설정
      apt:
        name: nginx
        state: present

    - name: 서비스용 디렉토리 생성
      file:
        path: /home/ubuntu/web_project
        state: directory
        owner: ubuntu
        group: ubuntu

    - name: 개발팀 저장소(web_dev) 소스 배포
      git:
        repo: "https://github.com/사용자계정/web_dev.git"
        dest: "/home/ubuntu/web_project"
        version: main
        force: yes
  # tasks로 모아두지 않아서 hablders를 넣어두는 것이 가능함
  handlers:
    - name: Restart MySQL
      service:
        name: mysql
        state: restarted

```

---

## 4. 저장소 분리 여부 결정 기준

| 구분 | 동일 저장소 관리 (권장) | 개별 저장소 관리 |
| --- | --- | --- |
| **장점** | 웹-DB 간의 IP 연결, 보안 그룹 설정 등 통합 관리가 용이함 | 각 구성 요소의 독립적인 버전 관리가 가능함 |
| **단점** | 저장소 규모가 커지면 복잡해질 수 있음 | 배포 시 여러 저장소를 동시에 관리해야 하는 번거로움 |
| **적합한 경우** | 현재 실습과 같은 **중소규모 인프라 및 전체 시스템 구축** | MSA(Microservice Architecture)와 같은 대규모 분산 환경 |

---

## 5. AWS 관련 비용 및 보안 주의사항

* **AWS RDS vs EC2 MySQL**: 실습을 위해 EC2에 직접 MySQL을 설치하는 것은 **Free Tier** 범위 내에서 가능하지만, 10대의 웹 서버와 3대의 DB 서버(총 13대)를 가동하면 무료 시간이 매우 빠르게 소진됩니다. 실습 후 반드시 **전체 종료(Terminate)** 하십시오.
* **Security Group (중요)**: DB 서버는 보안을 위해 **3306(MySQL)** 포트를 전체 개방하지 말고, **웹 서버 그룹의 사설 IP 대역**에서만 접속할 수 있도록 설정해야 합니다.
* **Storage 요금**: MySQL 데이터가 저장되는 EBS 볼륨의 용량과 스냅샷 요금이 발생할 수 있으므로 리소스 삭제 시 볼륨도 함께 삭제되는지 확인하세요.

---

Next Step: MySQL의 bind-address 설정 및 웹 서버와의 통신 확인 실습

---

Next Step: MySQL 원격 접속 설정 가이드
