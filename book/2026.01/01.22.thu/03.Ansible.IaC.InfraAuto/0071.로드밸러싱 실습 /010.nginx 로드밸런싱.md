https://github.com/putto4u/03.Ansible.IaC.InfraAuto/blob/main/0071.%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%AC%EC%8B%B1%20%EC%8B%A4%EC%8A%B5/010.nginx%20%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1.md

ha는 fail ovrer를 먹이는 것 = 투표를 해서 살아있는 게 과반수가 넘으면 자기가 함, 둘이 되면 과반수가 성립 됨

## Ansible Role 기반 Nginx 웹 서버 및 로드 밸런서 분리 구축 프로젝트

이번 프로젝트는 실무 표준 방식인 **Role(역할) 구조**를 채택하여 설계되었습니다. 웹 서버 설치 로직과 로드 밸런서 설정 로직을 물리적으로 분리함으로써, 향후 서버 증설이나 설정 변경 시 필요한 부분만 골라 실행할 수 있는 유연한 인프라 구조를 지향합니다.

---

### 1. 프로젝트 개요 및 특장점

* **역할 분리 (Roles)**: 웹 서버(`webserver`)와 로드 밸런서(`loadbalancer`)의 태스크를 독립된 디렉토리로 격리하여 가독성과 재사용성을 극대화했습니다.
* **동적 확장성**: `inventory.yml`의 `web_servers` 그룹에 IP만 추가하면, 로드 밸런서 템플릿이 이를 자동으로 감지하여 업스트림 리스트를 갱신합니다.
* **GitOps 친화적**: 각 역할이 독립적이기 때문에 특정 기능의 코드 변경 사항을 추적하기 쉬우며, 대규모 프로젝트로 확장 시 관리가 용이합니다.

---

### 2. 프로젝트 디렉토리 구조

실습을 시작하기 전, 아래와 같은 구조로 폴더와 파일을 생성해 주세요.

```text
nginx-role-project/
├── inventory.yml                # 전체 서버 그룹 및 IP 정의
├── deploy_site.yml              # 전체 시스템 구축용 메인 플레이북
├── roles/                       # 역할별 로직 보관함
│   ├── webserver/
│   │   └── tasks/
│   │       └── main.yml         # 웹 서버 설치 및 index.html 생성
│   └── loadbalancer/
│       ├── tasks/
│       │   └── main.yml         # LB 설치 및 설정 배포
│       └── templates/
│           └── lb_nginx.conf.j2 # LB 설정 템플릿

```

---

### 3. 주요 파일별 소스 코드

#### ① 인벤토리 파일 (`inventory.yml`)

```yaml
all:
  children:
    load_balancer:
      hosts:
        lb_node:
          ansible_host: 192.168.10.100    # 로드밸런서 IP
    web_servers:
      hosts:
        web_01:
          ansible_host: 192.168.10.101    # 웹 서버 1 IP
        web_02:
          ansible_host: 192.168.10.102    # 웹 서버 2 IP

```

#### ② 메인 플레이북 (`deploy_site.yml`)

```yaml
---
# 1. 웹 서버 역할 실행
- name: 백엔드 웹 서버 계층 배포
  hosts: web_servers
  become: true
  roles:
    - webserver                          # roles/webserver 디렉토리의 로직 실행

# 2. 로드 밸런서 역할 실행
- name: 전면 로드 밸런서 계층 배포
  hosts: load_balancer
  become: true
  roles:
    - loadbalancer                       # roles/loadbalancer 디렉토리의 로직 실행

```

#### ③ 웹 서버 역할 (`roles/webserver/tasks/main.yml`)

```yaml
---
- name: Nginx 웹 서버 패키지 설치
  ansible.builtin.apt:
    name: nginx
    state: present
    update_cache: true

- name: 서버별 개별 식별 페이지 생성
  ansible.builtin.copy:
    content: "<h1>Hello! This is {{ inventory_hostname }}</h1>"
    dest: /var/www/html/index.html
    mode: '0644'

```

#### ④ 로드 밸런서 역할 (`roles/loadbalancer/tasks/main.yml`)

```yaml
---
- name: Nginx 로드 밸런서 패키지 설치
  ansible.builtin.apt:
    name: nginx
    state: present
    update_cache: true

- name: 기본 설정 파일 제거
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: 로드 밸런싱 설정 템플릿 배포
  ansible.builtin.template:
    src: lb_nginx.conf.j2                # 같은 role 폴더 내 templates/에서 찾음
    dest: /etc/nginx/conf.d/load_balancer.conf
    mode: '0644'
  notify: Restart Nginx

# 핸들러 정의 (같은 파일 아래 혹은 handlers/main.yml에 위치)
- name: Restart Nginx
  ansible.builtin.service:
    name: nginx
    state: restarted

```

#### ⑤ LB 설정 템플릿 (`roles/loadbalancer/templates/lb_nginx.conf.j2`)

```nginx
upstream my_backend_servers {
    {% for host in groups['web_servers'] %}
    server {{ hostvars[host]['ansible_host'] }}:80 max_fails=3 fail_timeout=30s;
    {% endfor %}
}

server {
    listen 80;
    server_name localhost;

    location / {
        proxy_pass http://my_backend_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 실제 처리된 백엔드 서버를 확인하기 위한 응답 헤더
        add_header X-Backend-Server $upstream_addr;
    }
}

```

---

### 4. AWS 운영 시 과금 및 보안 가이드

* **EC2 고정 비용**: 로드 밸런서용 1대와 웹 서버용 2대, 총 3대의 인스턴스가 상시 가동되어야 합니다. 프리티어 기간이 종료된 경우 시간당 인스턴스 비용이 각각 청구됩니다.
* **공인 IP (EIP) 과금 주의**: AWS는 실행 중인 인스턴스에 연결된 1개의 공인 IP는 무료이지만, 인스턴스를 중지하거나 추가 IP를 할당할 경우 시간당 약 **$0.005**가 부과됩니다.
* **보안 그룹 최적화**:
* **LB SG**: 포트 80을 `0.0.0.0/0` (전체)에 개방합니다.
* **Web SG**: 포트 80을 오직 **LB의 보안 그룹 ID**로부터의 트래픽만 허용하도록 설정하여 직접 노출을 차단하세요.


* **자원 회수**: 실습 종료 직후 모든 인스턴스를 **Terminate(종료)** 해야 추가 과금을 방지할 수 있습니다.

---

Next Step: Ansible Vault를 활용한 민감 정보(비밀번호 등) 암호화 관리

프로젝트 디렉토리 구조, Role 기반 분리, 동적 템플릿 배포, AWS 운영 최적화

요청하신 대로 실무형 Role 구조로 분리하여 전체 프로젝트 파일을 구성했습니다. 이렇게 나누어 관리하면 추후 웹 서버만 따로 관리하거나 다른 프로젝트에서 LB 로직을 재사용하기 매우 편리해집니다. 각 파일의 위치가 헷갈리지는 않으신가요?
