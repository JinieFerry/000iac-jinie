https://github.com/putto4u/03.Ansible.IaC.InfraAuto/blob/main/0050.%EB%B3%B5%EC%9E%A1%ED%95%9C%ED%94%8C%EB%A0%88%EC%9D%B4%EB%B6%81%20%EC%95%A4%EC%84%9C%EB%B8%94%20Vault/0010.%EB%B3%B5%EC%9E%A1%ED%95%9C%ED%94%8C%EB%A0%88%EC%9D%B4%EB%B6%81%EC%84%A4%EC%A0%95%EC%95%A4%EC%84%9C%EB%B8%94Vault%EA%B5%AC%ED%98%84.md

λ³µμ΅ν• Ansible **ν”λ μ΄λ¶ μ„¤μ •**μ„ κµ¬μ΅°ν™”ν•λ” λ°©λ²•κ³Ό **Ansible Vault κµ¬ν„** λ°©λ²•μ„ μ‹¤λ¬΄ μμ λ¥Ό μ¤‘μ‹¬μΌλ΅ μƒμ„Έν μ„¤λ…ν•΄ λ“λ¦¬κ² μµλ‹λ‹¤. μ΄λ” μ•μ „ν•κ³  ν™•μ¥ κ°€λ¥ν• IaC(Infrastructure as Code)λ¥Ό κµ¬μ¶•ν•λ” λ° ν•„μμ μ…λ‹λ‹¤.

-----

## 1\. λ³µμ΅ν• ν”λ μ΄λ¶μ κµ¬μ΅°ν™” (λ¨λ“ν™”) π§±

λ³µμ΅ν• μΈν”„λΌλ¥Ό κ΄€λ¦¬ν•  λ•λ” ν”λ μ΄λ¶μ„ **λ¨λ“ν™”**ν•μ—¬ μ¬μ‚¬μ©μ„±, κ°€λ…μ„±, μ μ§€λ³΄μμ„±μ„ κ·Ήλ€ν™”ν•΄μ•Ό ν•©λ‹λ‹¤. \*\*Role(μ—­ν• )\*\*κ³Ό **Include/Import**κ°€ ν•µμ‹¬μ…λ‹λ‹¤.

### 1.1. Role (μ—­ν• )μ„ μ΄μ©ν• κµ¬μ΅°ν™” (ν‘μ¤€)

**Role**μ€ Ansible ν”„λ΅μ νΈ κµ¬μ΅°μ κΈ°λ³Έμ΄μ ν‘μ¤€μ…λ‹λ‹¤. νΉμ • μ„λ²„μ μ—­ν• (μ: μ›Ή μ„λ²„, DB μ„λ²„)μ— ν•„μ”ν• λ¨λ“  μ„¤μ •(νƒμ¤ν¬, λ³€μ, ν…ν”λ¦Ώ λ“±)μ„ μΊ΅μν™”ν•©λ‹λ‹¤.

| Role μ„λΈ λ””λ ‰ν† λ¦¬ | ν¬ν•¨ λ‚΄μ© |
| :--- | :--- |
| **`tasks/`** | μ„λ²„μ— μ‹¤ν–‰ν•  μ‹¤μ  μ‘μ—…(`main.yml`μ— νƒμ¤ν¬ λ©λ΅ μ •μ) |
| **`vars/`** | Role λ‚΄μ—μ„ μ‚¬μ©ν•  λ³€μ (Roleλ³„ λ³€μ) |
| **`defaults/`** | λ³€μκ°€ μ„¤μ •λμ§€ μ•μ•μ„ λ• μ‚¬μ©ν•  κΈ°λ³Έκ°’ (κ°€μ¥ λ‚®μ€ μ°μ„ μμ„) |
| **`templates/`** | Jinja2 ν…ν”λ¦Ώ νμΌ (`.j2` ν™•μ¥μ) |
| **`handlers/`** | `notify`μ— μν•΄ νΈμ¶λλ” μ¬μ‹μ‘ λ“± μ‘μ—… |

**λ©”μΈ ν”λ μ΄λ¶ (`site.yml`)μ—μ„μ Role μ‚¬μ©:**

```yaml
---
# DB μ„λ²„ κ·Έλ£Ήμ— mariadb Role μ μ©
- name: Deploy Database Tier
  hosts: dbservers
  become: yes
  roles:
    - mariadb
    - common_security # λ¨λ“  μ„λ²„μ— μ μ©λλ” λ³΄μ• Role
```

### 1.2. λ³€μ(Variable)μ μ²΄κ³„μ  κ΄€λ¦¬

λ³µμ΅ν• ν™κ²½μΌμλ΅ λ³€μλ” μ¤‘μ•™ μ§‘μ¤‘μ‹μΌλ΅ λ¶„λ¦¬ κ΄€λ¦¬ν•΄μ•Ό ν•©λ‹λ‹¤.

  * **`group_vars/`**: κ·Έλ£Ή(μ: `prod`, `dev`, `webservers`)λ³„ κ³µν†µ μ„¤μ • λ³€μ.
      * μ: `group_vars/prod.yml` νμΌμ— `env_tag: production` μ •μ.
  * **`host_vars/`**: κ°λ³„ μ„λ²„(μ: `web1`, `db2`)μ—λ§ μ μ©λλ” κ³ μ  λ³€μ.
      * μ: `host_vars/web1.yml` νμΌμ— `nginx_port: 8080` μ •μ.

### 1.3. νƒμ¤ν¬ νμΌ λ¨λ“ν™” (Include/Import)

Role λ‚΄μ—μ„ νƒμ¤ν¬κ°€ λ„λ¬΄ κΈΈμ–΄μ§€λ©΄ μ΄λ¥Ό μ—¬λ¬ νμΌλ΅ λ¶„λ¦¬ν•©λ‹λ‹¤.

| μ‚¬μ© λ°©λ²• | μ„¤λ… | μ‚¬μ© μμ‹ |
| :--- | :--- | :--- |
| **`include_tasks`** | **λ™μ **μΌλ΅ λ‹¤λ¥Έ νƒμ¤ν¬ νμΌμ„ ν¬ν•¨. `loop`λ‚ `when`κ³Ό ν•¨κ» μ‚¬μ©ν•μ—¬ μ‹¤ν–‰ μ‹μ μ— λ΅μ§μ„ μ μ–΄ν•  λ• μ μ©. | `- include_tasks: "install_{{ item }}.yml" loop: [p1, p2]` |
| **`import_tasks`** | **μ •μ **μΌλ΅ λ‹¤λ¥Έ νƒμ¤ν¬ νμΌμ„ ν†µν•©. ν”λ μ΄λ¶ κµ¬μ΅°λ¥Ό λ…ν™•ν•κ² μ •μν•  λ• μ‚¬μ©. | `- import_tasks: setup_network.yml` |

-----

## 2\. Ansible Vault κµ¬ν„ λ°©λ²• (λ³΄μ•) π”’

Ansible Vaultλ” λΉ„λ°€λ²νΈ, ν‚¤, μΈμ¦μ„ λ“± λ―Όκ° μ •λ³΄λ¥Ό μ•”νΈν™”ν•μ—¬ μ½”λ“λ¥Ό μ•μ „ν•κ² λ³΄κ΄€ν•  μ μκ² ν•©λ‹λ‹¤.

### 2.1. Vault ν™κ²½ μ¤€λΉ„

Ansible Vaultλ¥Ό μ‚¬μ©ν•λ ¤λ©΄ λ§μ¤ν„° λΉ„λ°€λ²νΈλ¥Ό μ„¤μ •ν•΄μ•Ό ν•©λ‹λ‹¤.

1.  **λΉ„λ°€λ²νΈ νμΌ μƒμ„± (κ¶μ¥)**: λ³΄μ•μƒ λ§μ¤ν„° λΉ„λ°€λ²νΈλ¥Ό νμΌλ΅ κ΄€λ¦¬ν•κ³  μ΄ νμΌμ„ Gitμ— μ¬λ¦¬μ§€ μ•λ„λ΅ ν•©λ‹λ‹¤.

    ```bash
    # vault_pass.txt νμΌμ„ μƒμ„±ν•κ³  λ§μ¤ν„° λΉ„λ°€λ²νΈλ¥Ό μ…λ ¥
    echo "MySuperSecretVaultPass" > ~/.ansible/vault_pass.txt
    ```

### 2.2. Vault νμΌ μƒμ„± λ° νΈμ§‘

λ―Όκ°ν• μ •λ³΄λ¥Ό λ‹΄μ„ λ³€μ νμΌ(`secrets.yml`)μ„ μƒμ„±ν•κ±°λ‚ κΈ°μ΅΄ νμΌμ„ νΈμ§‘ν•©λ‹λ‹¤.

| μ‘μ—… | λ…λ Ήμ–΄ | μ„¤λ… |
| :--- | :--- | :--- |
| **μƒ Vault νμΌ μƒμ„±** | `ansible-vault create group_vars/prod/secrets.yml` | νμΌμ„ λ§λ“¤λ©΄μ„ μ¦‰μ‹ μ•”νΈν™”ν•©λ‹λ‹¤. |
| **κΈ°μ΅΄ νμΌ μ•”νΈν™”** | `ansible-vault encrypt group_vars/prod/secrets.yml` | μΌλ° ν…μ¤νΈ νμΌμ„ μ•”νΈν™”λ νμΌλ΅ λ³€ν™ν•©λ‹λ‹¤. |
| **νμΌ λ‚΄μ© νΈμ§‘** | `ansible-vault edit group_vars/prod/secrets.yml` | μ•”νΈν™”λ νμΌμ„ λ³µνΈν™”ν•μ—¬ νΈμ§‘ν•κ³  μ €μ¥ μ‹ λ‹¤μ‹ μ•”νΈν™”ν•©λ‹λ‹¤. |

**μ•”νΈν™”λ νμΌ λ‚΄μ© (YAML ν•μ‹):**

```yaml
# group_vars/prod/secrets.yml νμΌ (λ‚΄λ¶€)
db_root_password: ENC[AES256_GCM,....]
aws_access_key: ENC[AES256_GCM,....]
```

### 2.3. ν”λ μ΄λ¶μ—μ„ Vault μ‚¬μ©

Vault νμΌμ€ μΌλ° λ³€μ νμΌμ²λΌ μ‚¬μ©ν•λ©΄ λ©λ‹λ‹¤. Ansibleμ΄ μ‹¤ν–‰ μ‹ μλ™μΌλ΅ μ²λ¦¬ν•©λ‹λ‹¤.

\*\*`group_vars/prod/secrets.yml`\*\*μ— μ •μλ λ³€μ μ‚¬μ© μμ‹:

```yaml
- name: Configure database root password
  community.mysql.mysql_user:
    name: root
    password: "{{ db_root_password }}" # Vault νμΌμ λ³€μλ… κ·Έλ€λ΅ μ‚¬μ©
    host: localhost
    state: present
```

### 2.4. ν”λ μ΄λ¶ μ‹¤ν–‰ (ν¨μ¤μ›λ“ μ „λ‹¬)

ν”λ μ΄λ¶μ„ μ‹¤ν–‰ν•  λ•, Vault ν¨μ¤μ›λ“λ¥Ό Ansibleμ—κ² μ „λ‹¬ν•΄μ•Ό ν•©λ‹λ‹¤.

```bash
# μµμ… 1: ν¨μ¤μ›λ“ νμΌ μ‚¬μ© (κ¶μ¥)
ansible-playbook site.yml --vault-password-file ~/.ansible/vault_pass.txt

# μµμ… 2: μ‹¤ν–‰ μ‹ μλ™ μ…λ ¥ (λ³΄μ•μ„±μ΄ λ‚®μ)
ansible-playbook site.yml --ask-vault-pass
```

Ansible Vaultλ¥Ό ν†µν•΄ λ―Όκ°ν• μ •λ³΄λ¥Ό μ•μ „ν•κ² κ΄€λ¦¬ν•¨μΌλ΅μ¨, μ½”λ“λ¥Ό Gitμ— μμ λ΅­κ² κ³µμ ν•λ©΄μ„λ„ λ³΄μ• κ·μ •μ„ μ¤€μν•λ” **μ „λ¬Έμ μΈ IaC μ›ν¬ν”λ΅μ°**λ¥Ό κµ¬μ¶•ν•  μ μμµλ‹λ‹¤.

---
## Ansible: ν™•μ¥ κ°€λ¥ν• λ€κ·λ¨ μΈν”„λΌ κµ¬μ΅° μ„¤κ³„

λ³µμ΅ν• μΈν”„λΌ ν™κ²½μ—μ„ ν”λ μ΄λ¶μ„ ν¨μ¨μ μΌλ΅ κ΄€λ¦¬ν•λ ¤λ©΄ λ‹¨μν• νμΌ λ‚μ—΄μ΄ μ•„λ‹, **μ—­ν• (Role)**κ³Ό **ν™κ²½(Environment)**μ΄ λ…ν™•ν λ¶„λ¦¬λ κµ¬μ΅°κ°€ ν•„μ”ν•©λ‹λ‹¤. μ΄λ” μλ°± λ€μ μ„λ²„λ¥Ό κ΄€λ¦¬ν•λ”λΌλ„ μ½”λ“μ μ¬μ‚¬μ©μ„±μ„ κ·Ήλ€ν™”ν•κ³  μ‹¤μλ¥Ό λ°©μ§€ν•λ” ν•µμ‹¬ μ „λµμ…λ‹λ‹¤.

---

### 1. μ‹¤λ¬΄ ν‘μ¤€ λ””λ ‰ν† λ¦¬ κµ¬μ΅° (Standard Layout)

μ•„λ κµ¬μ΅°λ” μμ² λ€ κ·λ¨μ μ„λ²„λ¥Ό μ΄μν•λ” μ‹¤λ¬΄ μ—”μ§€λ‹μ–΄λ“¤μ΄ κ°€μ¥ μ„ νΈν•λ” **Best Practice** κµ¬μ΅°μ…λ‹λ‹¤.

```text
ansible-project/
β”β”€β”€ site.yml                 # μ „μ²΄ μΈν”„λΌλ¥Ό λ°°ν¬ν•λ” λ§μ¤ν„° ν”λ μ΄λ¶
β”β”€β”€ webservers.yml           # μ›Ή μ„λ²„ κ³„μΈµ μ „μ© ν”λ μ΄λ¶
β”β”€β”€ dbservers.yml            # λ°μ΄ν„°λ² μ΄μ¤ κ³„μΈµ μ „μ© ν”λ μ΄λ¶
β”β”€β”€ inventory/               # ν™κ²½λ³„ μΈλ²¤ν† λ¦¬ κ΄€λ¦¬
β”‚   β”β”€β”€ production/
β”‚   β”‚   β”β”€β”€ hosts            # μ΄μ ν™κ²½ νΈμ¤νΈ λ¦¬μ¤νΈ
β”‚   β”‚   β””β”€β”€ group_vars/      # μ΄μ ν™κ²½ μ „μ© λ³€μ (DB μ ‘μ† μ •λ³΄ λ“±)
β”‚   β””β”€β”€ staging/
β”‚       β”β”€β”€ hosts            # μ¤ν…μ΄μ§• ν™κ²½ νΈμ¤νΈ λ¦¬μ¤νΈ
β”‚       β””β”€β”€ group_vars/      # μ¤ν…μ΄μ§• ν™κ²½ μ „μ© λ³€μ
β”β”€β”€ roles/                   # μ¬μ‚¬μ© κ°€λ¥ν• μ»΄ν¬λ„νΈ (ν•µμ‹¬)
β”‚   β”β”€β”€ common/              # λ¨λ“  μ„λ²„ κ³µν†µ μ„¤μ • (NTP, λ³΄μ• μ„¤μ • λ“±)
β”‚   β”‚   β”β”€β”€ tasks/main.yml
β”‚   β”‚   β”β”€β”€ handlers/main.yml
β”‚   β”‚   β””β”€β”€ defaults/main.yml
β”‚   β”β”€β”€ nginx/               # Nginx μ„¤μΉ λ° μ„¤μ • μ „μ© μ—­ν• 
β”‚   β”‚   β”β”€β”€ tasks/main.yml
β”‚   β”‚   β”β”€β”€ templates/       # μ„¤μ • νμΌ ν…ν”λ¦Ώ (*.j2)
β”‚   β”‚   β””β”€β”€ vars/main.yml
β”‚   β””β”€β”€ mysql/               # MySQL μ„¤μΉ λ° μ„¤μ • μ „μ© μ—­ν• 
β”β”€β”€ library/                 # μ»¤μ¤ν…€ λ¨λ“ (ν•„μ” μ‹)
β””β”€β”€ ansible.cfg              # Ansible μ„¤μ • νμΌ

```

---

### 2. κµ¬μ΅°λ³„ ν•µμ‹¬ μ—­ν•  μƒμ„Έ

#### 2.1. μΈλ²¤ν† λ¦¬ λ¶„λ¦¬ (`inventory/`)

μ΄μ(Production)κ³Ό κ°λ°(Staging) ν™κ²½μ„ λ””λ ‰ν† λ¦¬ μμ¤€μ—μ„ λ¶„λ¦¬ν•©λ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ μ‹¤μλ΅ μ΄μ μ„λ²„μ— κ°λ°μ© μ„¤μ •μ„ λ°°ν¬ν•λ” μ‚¬κ³ λ¥Ό λ°©μ§€ν•  μ μμµλ‹λ‹¤.

* **μ‹¤ν–‰ μμ‹**: `ansible-playbook -i inventory/production site.yml`

#### 2.2. λ³€μ κ΄€λ¦¬ μ°μ„ μμ„ (`group_vars/`)

* `group_vars/all.yml`: λ¨λ“  μ„λ²„μ— μ μ©λλ” κ³µν†µ λ³€μ (μ: νƒ€μ„μ΅΄, κ΄€λ¦¬μ κ³„μ •)
* `group_vars/webservers.yml`: μ›Ή μ„λ²„ κ·Έλ£Ήμ—λ§ μ μ©λλ” νΉμ • μ„¤μ •

#### 2.3. Roles (μ»΄ν¬λ„νΈν™”)

κ° μ—­ν• μ€ λ…λ¦½μ μΌλ΅ λ™μ‘ν•λ„λ΅ μ„¤κ³„ν•©λ‹λ‹¤. μλ¥Ό λ“¤μ–΄ `nginx` Roleμ€ μ–΄λ–¤ ν”„λ΅μ νΈμ—μ„ κ°€μ Έλ‹¤ μ¨λ„ λ™μ‘ν•΄μ•Ό ν•©λ‹λ‹¤. ν”„λ΅μ νΈ μ „μ© λ³€μλ” Role λ‚΄λ¶€κ°€ μ•„λ‹ `group_vars`μ—μ„ μ£Όμ…λ°›λ” λ°©μ‹μ„ μ·¨ν•©λ‹λ‹¤.

---

### 3. Ansible Vaultλ¥Ό ν™μ©ν• λ³΄μ• κµ¬μ΅°ν™”

λ³΄μ•μ΄ μ¤‘μ”ν• μ •λ³΄(DB λΉ„λ°€λ²νΈ, API ν‚¤ λ“±)λ” `group_vars` λ‚΄λ¶€μ `secrets.yml` νμΌμ— λ³„λ„λ΅ λ³΄κ΄€ν•λ©°, μ΄ νμΌλ§ Vaultλ΅ μ•”νΈν™”ν•©λ‹λ‹¤.

#### 3.1. λ³΄μ• λ³€μ λ¶„λ¦¬ κµ¬μ΅°

```text
group_vars/
β””β”€β”€ production/
    β”β”€β”€ vars.yml             # μΌλ° μ„¤μ • (μ•”νΈν™” λ¶ν•„μ”)
    β””β”€β”€ secrets.yml          # λΉ„λ°€λ²νΈ λ“± λ―Όκ° μ •λ³΄ (ansible-vaultλ΅ μ•”νΈν™”)

```

#### 3.2. Vault μ•”νΈν™” μ‹¤ν–‰

```bash
# λ³΄μ• νμΌ μƒμ„± (μ λ£ μ „ν™ μ„λΉ„μ¤ μ—†μ - λ΅μ»¬ μ•”νΈν™”)
ansible-vault create group_vars/production/secrets.yml

# κΈ°μ΅΄ νμΌ μ•”νΈν™”
ansible-vault encrypt group_vars/production/secrets.yml

```

#### 3.3. λ°°ν¬ μλ™ν™” μ‹ ν™μ©

CI/CD νμ΄ν”„λΌμΈ(Jenkins, GitHub Actions λ“±)μ—μ„ μ‚¬μ© μ‹, ν¨μ¤μ›λ“λ¥Ό ν…μ¤νΈ νμΌλ΅ μ €μ¥ν•μ—¬ μ°Έμ΅°ν•©λ‹λ‹¤.

```bash
# vault_pass.txt νμΌμ— μ•”νΈ μ €μ¥ ν›„ μ‹¤ν–‰
ansible-playbook -i inventory/production site.yml --vault-password-file .vault_pass

```

---

### 4. AWS μΈν”„λΌ κ΄€λ¦¬ μ‹ λΉ„μ© μ£Όμμ‚¬ν•­

Ansibleμ„ μ‚¬μ©ν•μ—¬ AWS λ¦¬μ†μ¤λ¥Ό λ™μ μΌλ΅ ν”„λ΅λΉ„μ €λ‹(EC2 μƒμ„± λ“±)ν•  λ• λ‹¤μ μ‚¬ν•­μ„ μ μν•μ‹­μ‹μ¤.

* **EC2 Instance (μ λ£)**: `amazon.aws.ec2_instance` λ¨λ“μ„ μ‚¬μ©ν•μ—¬ μΈμ¤ν„΄μ¤λ¥Ό μƒμ„±ν•λ©΄ μ¦‰μ‹ μ‹κ°„λ‹Ή κ³ΌκΈμ΄ μ‹μ‘λ©λ‹λ‹¤. ν…μ¤νΈκ°€ λλ‚λ©΄ λ°λ“μ‹ `state: absent`λ΅ μ‚­μ ν•΄μ•Ό ν•©λ‹λ‹¤.
* **EBS Volumes (μ λ£)**: μΈμ¤ν„΄μ¤λ¥Ό μ‚­μ ν•΄λ„ λ£¨νΈ λ³Όλ¥¨ μ™Έμ μ¶”κ°€ EBSλ” λ‚¨μ•„μ„ κ³ΌκΈλ  μ μμΌλ‹ μ£Όμκ°€ ν•„μ”ν•©λ‹λ‹¤.
* **Free Tier**: `t2.micro` λλ” `t3.micro` νƒ€μ…μ„ μ‚¬μ©ν•κ³  μλ”μ§€ ν”λ μ΄λ¶μ `instance_type` λ³€μλ¥Ό ν™•μΈν•μ‹­μ‹μ¤.

---

Next Step: Ansible Role μƒμ„± μ‹¤μµ λ° ν…ν”λ¦Ώ ν™μ©λ²•

κ°μΈ μ„¤μ •μ— λ”°λΌ κΉƒν—λΈ λ§ν¬λ‹¤μ΄ ν¬λ§·μΌλ΅ μ‘μ„±λμ—μµλ‹λ‹¤. λ¨λ“  AWS κ΄€λ ¨ λ‚΄μ©μ€ κ³ΌκΈ μ μμ‚¬ν•­μ„ ν¬ν•¨ν•μ€μΌλ©°, λ¶ν•„μ”ν• μΈμ‚¬λ§μ€ μƒλµν•μ€μµλ‹λ‹¤.

λ””λ ‰ν† λ¦¬ κµ¬μ΅° μλ™ν™” μ¤ν¬λ¦½νΈ | Role κΈ°λ° ν”λ μ΄λ¶ μ‘μ„± | Vault μλ™ λ³µνΈν™” μ„¤μ •

μ €μ λ‹µλ³€μ΄ λ„μ›€λμ…¨κΈΈ λ°”λλ‹λ‹¤. μ¶”κ°€λ΅ κ¶κΈν• μ μ΄ μμΌμ‹λ©΄ μ–Έμ λ“  λ§μ”€ν•΄ μ£Όμ„Έμ”.
