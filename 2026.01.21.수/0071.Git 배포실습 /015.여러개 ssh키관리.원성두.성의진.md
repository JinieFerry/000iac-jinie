# Chapter 5. 다중 서버 접속을 위한 고급 SSH 키 관리 전략

서버 인프라가 확장됨에 따라 관리해야 할 대상이 GitHub, 사내 Git 서버, AWS EC2 인스턴스 등으로 늘어나게 된다. 이때 단일 SSH 키(`id_rsa`)만 사용하면 보안 사고 발생 시 모든 서버의 접근 권한이 위협받으며, 서버별로 다른 인증 정책을 대응하기 어렵다. 본 장에서는 `~/.ssh/config` 파일을 활용하여 다수의 서버 접속 정보를 체계적으로 관리하는 표준 아키텍처를 다룬다.

---

### 1. 키 페어 분리 생성 (Identity Separation)

가장 먼저 해야 할 일은 용도별로 물리적인 키 파일을 분리하는 것이다. 하나의 만능 열쇠를 사용하지 않고, 접속 대상마다 고유한 키를 생성한다.

**명령어 구문:**
`-f` 옵션을 사용하여 기본 경로(`~/.ssh/id_rsa`)가 아닌 명시적인 파일명을 지정한다.

```bash
# 1. GitHub 개인용 키 생성
ssh-keygen -t ed25519 -C "personal@email.com" -f ~/.ssh/id_github_personal

# 2. 회사 사내 Git 서버용 키 생성
ssh-keygen -t ed25519 -C "work@company.com" -f ~/.ssh/id_company_git

# 3. AWS 인프라 접속용 키 생성 (RSA 방식이 호환성이 높음)
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_aws_prod

```

---

### 2. SSH Config 파일 구성 (Core Architecture)

키를 여러 개 만들었더라도, SSH 클라이언트는 기본적으로 `id_rsa` 하나만 시도하다가 실패한다. 이를 해결하기 위해 **SSH Config** 파일에 "어떤 호스트에 접속할 때 어떤 키를 제출할지" 매핑 정보를 작성해야 한다.

**파일 경로:** `~/.ssh/config` (파일이 없다면 생성)

**작성 예시 (주요 시나리오별 구성):**

```ssh
# --------------------------------------------------------
# 1. GitHub (Personal)
# 별칭(Host)을 github.com으로 설정하여 일반적인 git clone 명령어와 호환 유지
# --------------------------------------------------------
Host github.com
    HostName github.com
    User git
    IdentityFile ~/.ssh/id_github_personal

# --------------------------------------------------------
# 2. 사내 Git 서버 (Company Work)
# IP 주소 대신 별칭(my-work-git) 사용 가능
# --------------------------------------------------------
Host work-git
    HostName 192.168.10.50
    User git
    Port 2222                        # 보안을 위해 변경된 포트 사용 시 명시
    IdentityFile ~/.ssh/id_company_git

# --------------------------------------------------------
# 3. AWS EC2 Production Server
# 매번 긴 DNS 주소를 입력할 필요 없이 'ssh aws-prod'로 접속 가능
# --------------------------------------------------------
Host aws-prod
    HostName ec2-203-0-113-25.compute-1.amazonaws.com
    User ubuntu
    IdentityFile ~/.ssh/id_aws_prod.pem

```

**설정의 주요 이점:**

* **자동 키 매핑:** 사용자가 `ssh work-git`이라고만 입력해도, 시스템은 자동으로 `192.168.10.50` 주소를 찾고 `id_company_git` 키 파일을 제출한다.
* **명령어 단축:** 긴 호스트 주소와 포트 번호, 유저 이름을 매번 입력할 필요가 없다.

---

### 3. 파일 권한 보안 설정 (Permission Hardening)

SSH는 보안에 매우 민감하여, 키 파일이나 설정 파일의 권한이 너무 개방되어 있으면(예: 다른 사용자가 읽을 수 있음) 접속 자체를 거부한다. 다음 권한 설정을 준수해야 한다.

```bash
# .ssh 디렉토리: 소유자만 읽기/쓰기/실행 가능
chmod 700 ~/.ssh

# 공개키(.pub): 타인에게 공개되어도 됨
chmod 644 ~/.ssh/*.pub

# 개인키(Private Key): 반드시 소유자만 읽기 가능해야 함 (가장 중요)
chmod 600 ~/.ssh/id_github_personal
chmod 600 ~/.ssh/id_company_git
chmod 600 ~/.ssh/id_aws_prod

# config 파일: 소유자 읽기/쓰기, 그룹/타인 읽기 불가 권장
chmod 600 ~/.ssh/config

```

---

### 4. 접속 테스트 및 디버깅

설정 완료 후, 실제 해당 키가 올바르게 사용되는지 검증한다. `-v` (verbose) 옵션을 사용하면 디버그 로그를 볼 수 있다.

**검증 명령어:**

```bash
# 사내 Git 서버 접속 테스트 (Config에 설정한 별칭 사용)
ssh -v work-git

# GitHub 접속 테스트
ssh -T git@github.com

```

**로그 분석 포인트:**
로그 출력 중 `Offering public key: ...` 라인을 확인한다. 접속하려는 서버에 맞춰 `config`에 등록한 올바른 경로의 키 파일이 제시되고 있다면 설정이 성공한 것이다.

Next Step:
Git Submodule을 활용한 공통 모듈 관리 전략
